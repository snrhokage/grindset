---
tags:
  - browser
links:
  - https://habr.com/ru/companies/avito/articles/710674/
---


HTTP — это протокол без сохранения состояния. Это значит, что когда на сервер поступают два запроса, он не понимает: их послал один клиент или разные. В реальных приложениях постоянно надо идентифицировать пользователя: проверять, авторизован ли он, выводить пользовательские рекомендации, хранить корзину выбранных товаров в магазине. Для этого есть механизм Cookies.

**Cookies** — это фрагмент данных, в которых сервер передаёт важную информацию о клиенте. Браузер получает этот фрагмент, сохраняет его и с каждым последующим запросом отсылает обратно на сервер. Так он понимает, от какого клиента пришёл запрос.

Куки выглядят, как пара `ключ=значение`. Для их установки сервер должен в ответе на запрос клиента прислать заголовок `Set-Cookie` со значением.

```
Set-Cookie: token=123abc
```

Как только браузер получит его в ответ на запрос, он сохранит значение куки в Cookie Storage. В каждый последующий запрос браузер будет добавлять сохранённые значения в заголовке `Cookie`.

Пример выше — это сессионный куки, для них не указываются сроки хранения. Он будет существовать, пока пользователь не закроет вкладку с сайтом в браузере. Но многие браузеры используют механизм восстановления сессий, поэтому сессионные куки теоретически могут жить вечно.

Обычно кукам устанавливается фиксированное время жизни. Это можно сделать двумя способами: 

- установить дату истечения срока годности — `Expires`, 
    
- установить количество секунд, по истечении которых кука перестанет быть актуальной — `MAX_AGE`.
    

Допустим, срок жизни куки из предыдущего примера должен истечь 1 января 2030 года. Тогда нужно прислать заголовок со значением куки и датой истечения срока годности, разделёнными точкой с запятой.

```
Set-Cookie: token=123abc; Expires=Tue, 01 Jan 2030 00:00:00 -0000
```

Теперь с наступлением 1 января 2030 года кука станет невалидной и удалится.

В альтернативном варианте срок жизни куки должен истечь через две минуты. Тогда вместо даты нужно прислать количество секунд в параметре `MAX_AGE`:

```
Set-Cookie: token=123abc; MAX_AGE=120
```

Разные браузеры могут использовать разные параметры для установки времени жизни куки. Поэтому зачастую сервер присылает оба варианта, а браузер сам выбирает поддерживаемый параметр.

```
Set-Cookie: token=123abc; Expires=Thu, 05 Aug 2021 18:45:00 -0000; MAX_AGE=120
```

Стандарт **RFC6265** 1, описывает куки. Он закрепляет правило, что имена параметров — регистронезависимые. Поэтому эта запись тоже будет валидной:

```
Set-Cookie: token=123abc; expires=Thu, 05 Aug 2021 18:45:00 -0000; max_age=120
```

### Область видимости Cookies

Параметры `domain` и `path` управляют областью видимости куки и определяют, на каких поддоменах и для каких URL они будут работать. Если не указать параметр `domain`, то он по умолчанию будет равен хосту сайта, например, example.com. Тогда куки не будут работать для поддоменов, например, `test.example.com`. Если указать значение `domain`, то куки будет работать для хоста и всех поддоменов.

Параметр `path` указывает, по каким URL при запросе ресурсов необходимо передавать куку в заголовке. Если установить `path=/`, то куки будут отправляться для всех запросов. Если указать значение `path=/api`, то они будут передаваться для всех запросов на ресурсы, URL которых начинается с `/api`. 

Расширим предыдущий пример:

```
Set-Cookie: token=123abc; expires=Thu, 05 Aug 2021 18:45:00 -0000; max_age=120; domain=example.com; path=/api
```

Уникальный идентификатор куки — их ключ (в примере — token), значения `domain` и `path`. Если нужно переопределить значение ранее установленных куки, то эти три параметра должны совпадать. В противном случае браузер создаст новые. А ещё не существует метода для удаления куки. Можно только установить её повторно и указать дату истечения срока годности `expires` в прошлом или нулевой или отрицательный `max_age`.

### Защита Cookies

Куки представляют два параметра, которые защищают их от различных атак.

Параметр `secure` говорит о том, что такие куки будут отсылаться только по HTTPS-соединению. Если сайт работает по HTTP, то значение не будет передано. `Secure` не обеспечивает дополнительного шифрования, поэтому не стоит хранить чувствительные данные в куках.

Параметр `httpOnly` создаёт куки, к которым нельзя обратиться из кода JavaScript в браузере. Так можно избежать XSS-атак.2

### Отправка на сервер

Куки отправляются на сервер при каждом запросе, если не подошла их дата истечения срока годности и параметры `path` и `domain` соответствует URL ресурса. Они передаются одной строкой в значении заголовка запроса `Cookie` и разделяются точкой с запятой.

```
Cookie: key1=value1; key2=value2;
```

### Директива Евросоюза о Cookie

25 мая 2011 года в силу вступила Директива 2009/136/EC Евросоюза о куки.3 Она требует запрашивать разрешение пользователя на получение и использование информации с его компьютера. Поэтому почти каждый сайт при первом посещении или после очистки кеша выводит баннер с запросом на использование Cookies.