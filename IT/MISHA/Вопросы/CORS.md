---
tags:
  - browser
links:
  - https://habr.com/ru/companies/avito/articles/710674/
---
`Cross-Origin Resource Sharing (CORS)` — механизм, использующий дополнительные HTTP-заголовки, чтобы дать возможность агенту пользователя получать разрешения на доступ к выбранным ресурсам с сервера на источнике (домене), отличном от того, что сайт использует в данный момент. Говорят, что агент пользователя делает запрос с другого источника (cross-origin HTTP request), если источник текущего документа отличается от запрашиваемого ресурса доменом, протоколом или портом.

## Как можно обойти ошибку с CORS?
%% - установить заголовки `Allow-Origin`
- отключить в браузере `CORS` %%
- **Прокси сервер**
## CORS

По умолчанию в браузере действует политика безопасности `Same Origin Policy`. Это означает, что доступ к ресурсам можно получить, только если источник этих ресурсов и источник запроса совпадают. Это сделано для того, чтобы некий сайт хакеров `evil.com` не мог получить доступ, например, к почтовому ящику на домене `gmail.com` и прочитать письма. Эта стратегия работала долгое время, когда JavaScript считался браузерным языком для украшения страничек и не умел делать AJAX-запросы.

Со временем разработчики поняли, что хотят уметь отправлять данные на сервер и получать их при помощи асинхронных запросов. Но политика `Same Origin` не позволяет сделать этого. После долгих обсуждений был предложен механизм `CORS — Cross-Origin Resource Sharing.`

Этот механизм использует дополнительные HTTP-заголовки. С ним браузер пользователя получает разрешения на доступ к выбранным ресурсам, если домен сайта и домен запрашиваемого ресурса отличаются.

### Простой запрос
Например, сайт находится на домене `example.com`. Запрос отправляется на сайт, который находится на домене `web-server.com`. Для начала браузер должен понять, сложный этот запрос или простой. Простой запрос отправляется методом `GET`, `POST` или `HEAD` и содержит только следующие заголовки:

- Accept;
- Accept-Language;
- Content-Language;
- Content-Type со значением `application/x-www-form-urlencoded`, `multipart/form-data` или `text/plain`.

Остальные запросы считаются сложными. Например, если он отправляется методом `DELETE`или содержит заголовок `Authorization`. Простые запросы браузер отправляет напрямую на сервер и автоматически добавляет к ним заголовок `Origin`. Его значение равно URL хоста, с которого отправляется запрос. В нашем примере это `Origin: https://example.com`. 

```
POST /path HTTP/1.0
Host: web-server.com
Origin: example.com
Content-Type: text/plain
```

Сервер принимает такой запрос и определяет, разрешить хосту получить этот ресурс или отказать в запросе. Для этого в ответе используется специальный заголовок `Access-Control-Allow-Origin`. Он определяет, с каких источников разрешено принимать запросы. Если указать `Access-Control-Allow-Origin: http://example.com`, то запрос на ресурс будет всегда разрешён только домену `example.com`. Если нужно разрешить получать ресурс с любого домена, то в ответе на запрос должен быть заголовок  `Access-Control-Allow-Origin: *`. 

Браузер заблокирует ответ на запрос, если:
- сервер вернёт в ответе заголовок `Access-Control-Allow-Origin: null`, 
- значение не будет совпадать с переданным в заголовке запроса `Origin`,
- не будет заголовка.    

### Сложный запрос
Если браузер обнаружит сложный запрос, то сначала отправит серверу `preflight` — предварительный запроc при помощи HTTP-метода `OPTIONS`. В запрос при этом добавляется заголовок `Access-Control-Request-Method`, в значении которого указывается HTTP-метод оригинального запроса.

Если в оригинальном запросе передаются заголовки не из списка разрешённых, то в запрос `OPTIONS` дополнительно добавляется заголовок `Access-Control-Request-Headers`. В его значении через запятую перечисляются все заголовки оригинального запроса. 

В случае отправки `preflight`-запроса сервер также должен вернуть заголовок `Access-Control-Allow-Origin` с необходимым значением.

Если в запрос добавлен заголовок `Access-Control-Request-Method`, то сервер в ответе должен указать, какие HTTP-методы разрешено использовать для запроса ресурса в заголовке ответа `Access-Control-Allow-Methods`.

Если в запрос добавлен заголовок `Access-Control-Request-Headers`, то сервер в ответе должен указать, какие HTTP-заголовки разрешено использовать для запроса ресурса в заголовке ответа `Access-Control-Allow-Headers`. 

### Пример ответа на `preflight`-запрос:

```
HTTP/1.0 200 OK
Date: Thu, 29 Jul 2021 19:20:01 GMT
Connection: close
Server: gunicorn/19.9.0
Access-Control-Allow-Origin: *
Access-Control-Allow-Methods: DELETE, GET, POST
Access-Control-Allow-Headers: X-Custom-Header, Authorization
```

Браузер получает ответ и после этого сверяет значения `Origin`, разрешенных заголовков и методов. Если всё совпадает, отправляет оригинальный запрос на сервер. Если разрешённые параметры не совпадают с фактическими, браузер блокирует отправку оригинального запроса и сообщает об ошибке.

Иногда необходимо уметь передавать [[Cookies]] при обращении к другим доменам. Заголовок `Cookie` не относится к списку разрешенных и попадает под политику безопасности. Чтобы их можно было передавать, сервер в ответ на preflight и на оригинальный запрос должен возвращать заголовок `Access-Control-Allow-Credentials: true`. Для работы куки также нужно возвращать в заголовке `Access-Control-Allow-Origin` конкретное значение разрешённого хоста.

Ответ от кроссдоменного запроса получен. Допустим, нужно получить доступ к заголовкам в коде JavaScript в браузере и прочитать их значения. Сделать это не так просто, потому что по умолчанию доступ из JavaScript для кроссдоменных запросов есть только к следующим заголовкам:

- Cache-Control
- Content-Language
- Content-Length
- Content-Type
- Expires
- Last-Modified
- Pragma

Если JS попытается прочитать значение другого заголовка, то получит `null`. Но сервер в ответе на запрос может перечислить заголовки, к которым можно получить доступ из Javascript в заголовке `Access-Control-Expose-Headers`. Заголовки указываются через запятую. Например, `Access-Control-Expose-Headers: Authorization, X-Version`.

Заголовок ответа сервера `Access-Control-Max-Age` сообщает браузеру, насколько предзапрос может быть кэширован и опущен при запросах к серверу. Значение указывается в секундах. Если после первого выполнения `preflight`-запроса время жизни `Max-Age` не вышло, то повторной отправки не будет. Оригинальный запрос выполнится сразу.